# Presigned Download & Preview URL Implementation

## Overview

This document describes the implementation of presigned (HMAC-authenticated) download and preview URLs for the filesystem storage backend, matching the existing presigned upload URL functionality.

## Implementation Summary

### 1. Storage Backend Changes (`pkg/simplecontent/storage/fs/fs.go`)

#### Added Fields
- `downloadSigner *presigned.Signer` - Separate signer for GET requests (downloads/previews)

#### Updated Methods

**`New()` Constructor**
- Initializes both upload signer (PUT method) and download signer (GET method)
- Both use the same secret key but different URL patterns

**`GetDownloadURL()`**
- Now generates signed URLs when `downloadSigner` is configured
- Includes filename parameter in signature to prevent tampering
- Falls back to unsigned URLs for backward compatibility

**`GetPreviewURL()`**
- Now generates signed URLs when `downloadSigner` is configured
- Falls back to unsigned URLs for backward compatibility

#### New Methods

**`ValidateDownloadSignature(objectKey, signature, expiresAt, filename)`**
- Validates HMAC signature for download requests
- Includes filename in validation payload
- Returns nil if no signer configured (backward compatible)

**`ValidatePreviewSignature(objectKey, signature, expiresAt)`**
- Validates HMAC signature for preview requests
- Returns nil if no signer configured (backward compatible)

### 2. HTTP Server Changes (`cmd/server-configured/main.go`)

#### Added Routes
```go
r.Get("/download/*", s.handlePresignedDownload)
r.Get("/preview/*", s.handlePresignedPreview)
```

#### New Handlers

**`handlePresignedDownload()`**
- Extracts object key from URL path
- Validates signature and expiration (if signer enabled)
- Downloads file from blob store
- Sets Content-Disposition: attachment with filename
- Streams file to response

**`handlePresignedPreview()`**
- Similar to download handler
- Sets Content-Disposition: inline instead of attachment
- Allows in-browser preview of supported file types

### 3. Key Design Decisions

#### Separate Signers for Upload vs Download
- **Upload Signer**: Pattern `/upload/{key}`, Method `PUT`
- **Download Signer**: Pattern `/download/{key}`, Method `GET`
- **Rationale**: Different HTTP methods require different signature payloads for security

#### Filename Parameter in Signature
- Download URLs can include `?filename={name}` parameter
- Filename is included in HMAC signature payload
- **Rationale**: Prevents attackers from changing filename after URL is signed

#### Backward Compatibility
- If `FS_SIGNATURE_SECRET_KEY` is NOT configured:
  - URLs generated without signatures (current behavior)
  - Validation endpoints allow all requests
- If `FS_SIGNATURE_SECRET_KEY` IS configured:
  - URLs include `signature` and `expires` query parameters
  - Validation endpoints enforce HMAC authentication

## Configuration

### Environment Variables

```bash
# Enable presigned URL authentication for filesystem storage
FS_SIGNATURE_SECRET_KEY=your-secret-key-here

# Optional: Set expiration time (default: 3600 seconds / 1 hour)
FS_PRESIGN_EXPIRES_SECONDS=3600

# Required: Set URL prefix for presigned URLs
FS_URL_PREFIX=http://localhost:8080/api/v1

# Required: Use storage-delegated URL strategy to get presigned URLs in content details
URL_STRATEGY=storage-delegated

# Set filesystem as default storage backend
DEFAULT_STORAGE_BACKEND=fs
```

### URL Strategy Options

The system supports three URL strategies:

1. **`content-based`** (default) - Application-routed URLs
   - Downloads: `/api/v1/contents/{id}/download`
   - Best for: Development, maximum control
   - Presigned URLs: Not used (app handles downloads)

2. **`storage-delegated`** - Direct storage backend URLs
   - Downloads: `/api/v1/download/{objectKey}?signature={hmac}&expires={timestamp}`
   - Best for: Testing presigned URLs locally
   - Presigned URLs: Generated by storage backend

3. **`cdn`** - CDN URLs for downloads
   - Downloads: `https://cdn.example.com/{objectKey}`
   - Best for: Production with CDN
   - Presigned URLs: Can be used with CDN + signed URLs

## URL Examples

### Without Signature (No Secret Key Configured)
```
Download: http://localhost:8080/api/v1/download/originals/objects/ab/cd1234_file.pdf
Preview:  http://localhost:8080/api/v1/preview/originals/objects/ab/cd1234_file.pdf
```

### With Signature (Secret Key Configured)
```
Download: http://localhost:8080/api/v1/download/originals/objects/ab/cd1234_file.pdf?signature=63d4dc5af24c...&expires=1759763275

Preview:  http://localhost:8080/api/v1/preview/originals/objects/ab/cd1234_file.pdf?signature=1ce8ae4dad37...&expires=1759763275

Download with filename:
http://localhost:8080/api/v1/download/originals/objects/ab/cd1234_file.pdf?filename=document.pdf&signature=a7b2c8f9e1...&expires=1759763275
```

## Security Features

### HMAC-SHA256 Signature
- Cryptographic signature prevents URL tampering
- Uses secret key known only to server
- Different signatures for different HTTP methods (GET vs PUT)

### Time-Based Expiration
- URLs automatically expire after configured duration
- Default: 1 hour (3600 seconds)
- Expired URLs return 403 Forbidden

### Constant-Time Comparison
- Signature validation uses `hmac.Equal()` for constant-time comparison
- Prevents timing attacks that could reveal valid signatures

### Method Validation
- Upload signatures only valid for PUT requests
- Download/preview signatures only valid for GET requests
- Prevents signature reuse across different operations

### Filename Tampering Protection
- Filename parameter included in signature payload
- Changing filename invalidates signature
- Prevents malicious filename injection

## Testing

### Test Script
Run the provided test script to verify presigned download/preview functionality:

```bash
# Start server with presigned URLs enabled
ENVIRONMENT=development \
PORT=8080 \
DATABASE_TYPE=memory \
DEFAULT_STORAGE_BACKEND=fs \
FS_BASE_DIR=./data/test-storage \
FS_URL_PREFIX=http://localhost:8080/api/v1 \
FS_SIGNATURE_SECRET_KEY=my-secret-key-12345 \
FS_PRESIGN_EXPIRES_SECONDS=3600 \
URL_STRATEGY=storage-delegated \
./server-configured

# Run test script in another terminal
./test_presigned_download.sh
```

### Test Coverage
The test script verifies:
1. ✅ Presigned download URL generation
2. ✅ Presigned preview URL generation
3. ✅ Valid signature acceptance
4. ✅ Content download with valid signature
5. ✅ Content preview with valid signature
6. ✅ Expired URL rejection (403 Forbidden)
7. ✅ Invalid signature rejection (403 Forbidden)

### Expected Output
```
================================
Presigned Download/Preview URL Test
================================

✓ Download URL contains signature (presigned URL is enabled)
✓ Downloaded content matches uploaded content
✓ Preview URL contains signature (presigned URL is enabled)
✓ Preview content matches uploaded content
✓ Expired URL correctly rejected (403 Forbidden)
✓ Invalid signature correctly rejected (403 Forbidden)

================================
All tests passed! ✓
================================
```

## Files Modified

1. **`pkg/simplecontent/storage/fs/fs.go`**
   - Added `downloadSigner` field
   - Updated `New()`, `GetDownloadURL()`, `GetPreviewURL()`
   - Added `ValidateDownloadSignature()`, `ValidatePreviewSignature()`

2. **`cmd/server-configured/main.go`**
   - Added routes: `GET /download/*` and `GET /preview/*`
   - Added handlers: `handlePresignedDownload()` and `handlePresignedPreview()`

3. **`test_presigned_download.sh`** (new file)
   - Comprehensive test script for presigned download/preview URLs

## Usage Example

### Client Code (JavaScript)

```javascript
// Get content details with presigned URLs
const response = await fetch(`/api/v1/contents/${contentId}/details`);
const details = await response.json();

// Download file using presigned URL
const downloadResponse = await fetch(details.download);
const blob = await downloadResponse.blob();
const url = window.URL.createObjectURL(blob);

// Create download link
const a = document.createElement('a');
a.href = url;
a.download = 'document.pdf';
a.click();

// Preview in browser
const previewWindow = window.open(details.preview, '_blank');
```

### Server-to-Server Download

```bash
# Get content details
CONTENT_ID="123e4567-e89b-12d3-a456-426614174000"
DETAILS=$(curl -s "http://localhost:8080/api/v1/contents/$CONTENT_ID/details")

# Extract download URL
DOWNLOAD_URL=$(echo "$DETAILS" | jq -r '.download')

# Download file
curl -o file.pdf "$DOWNLOAD_URL"
```

## Compatibility Matrix

| FS_SIGNATURE_SECRET_KEY | URL_STRATEGY | Behavior |
|-------------------------|--------------|----------|
| Not set | content-based | Unsigned content-routed URLs |
| Not set | storage-delegated | Unsigned direct storage URLs |
| Set | content-based | Signed content-routed URLs (not used) |
| Set | storage-delegated | **Signed direct storage URLs** ✅ |

## Migration Path

### From Unsigned URLs
1. Deploy code with presigned URL support
2. Test with `URL_STRATEGY=storage-delegated` (URLs unsigned)
3. Add `FS_SIGNATURE_SECRET_KEY` environment variable
4. All new URLs automatically signed
5. Existing unsigned URLs continue working

### Production Deployment
1. Generate strong secret key: `openssl rand -hex 32`
2. Set environment variables:
   ```bash
   FS_SIGNATURE_SECRET_KEY=<generated-key>
   FS_PRESIGN_EXPIRES_SECONDS=3600
   URL_STRATEGY=storage-delegated
   ```
3. Restart server
4. All URLs now require valid signatures

## Benefits

### Security
- **Time-limited access**: URLs expire automatically
- **Tamper-proof**: HMAC signature prevents URL modification
- **Method enforcement**: Upload/download operations separated
- **No authentication tokens**: URLs are self-contained and secure

### Performance
- **Direct download**: No application server proxy (in storage-delegated mode)
- **Reduced server load**: File serving handled by storage layer
- **Scalability**: Works with CDN for global distribution

### Flexibility
- **Backward compatible**: Works without secret key (unsigned URLs)
- **Multiple strategies**: Content-based, storage-delegated, or CDN
- **Easy testing**: Local filesystem mimics S3 presigned URL behavior

## Related Documentation

- `PRESIGNED_UPLOAD_AUTH.md` - Presigned upload URL authentication
- `PRESIGNED_PACKAGE.md` - Reusable presigned URL package
- `pkg/simplecontent/presigned/README.md` - Presigned package API
- `CLAUDE.md` - Project architecture and conventions
